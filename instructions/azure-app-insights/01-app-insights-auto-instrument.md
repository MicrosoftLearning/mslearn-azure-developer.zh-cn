---
lab:
  topic: Application Insights
  title: 使用自动检测监视应用程序
  description: '了解如何通过配置自动检测，在不修改代码的情况下，在 Application Insights 中监视应用程序 '
---

# 使用自动检测监视应用程序

此练习将创建一个启用了 Application Insights 的 Azure 应用服务 Web 应用，配置自动检测（无需修改代码），创建并部署一个 Blazor 应用程序，然后在 Application Insights 中查看应用程序指标和错误数据。 无需修改代码即可实现全面的应用程序监视与可观测性，这会让部署和迁移流程更简便。

在本练习中执行的任务：

* 创建启用了 Application Insights 的 Web 应用资源
* 为 Web 应用配置检测。
* 创建新的 Blazor 应用并将其部署到 Web 应用资源。
* 在 Application Insights 中查看应用程序活动
* 清理资源

此练习大约需要 20 分钟才能完成****。

## 在 Azure 中创建资源

1. 在浏览器中，导航到 Azure 门户，网址为：[https://portal.azure.com](https://portal.azure.com)；如果出现提示，请使用 Azure 凭据登录。
1. 选择位于主页顶部附近的“**Azure 服务**”标题中的“**+ 创建资源**”。 
1. 在“**搜索商城**”搜索栏中，输入 *Web 应用*，然后按 **Enter** 开始搜索。
1. 在Web 应用磁贴中，选择“**创建**”下拉列表，然后选择“**Web 应用**”。

    ![Web 应用磁贴的屏幕截图。](./media/create-web-app-tile.png)

选择“**创建**”将打开一个模板，其中包含几个选项卡，用于填写有关部署的信息。 以下步骤将引导你完成要在相关选项卡中进行的更改。

1. 使用下表中的信息填写“**基本信息**”选项卡：

    | 设置 | 操作 |
    |--|--|
    | **订阅** | 保留默认值。 |
    | **资源组** | 选择“新建”，输入 `rg-WebApp`，然后选择“确定”。 如果你愿意，也可以选择现有资源组。 |
    | **Name** | 输入唯一名称，例如 YOUR-INITIALS-monitorapp****。 将 YOUR-INITIALS 替换为你姓名的首字母或其他值****。 名称需要是唯一的，因此可能需要进行一些更改。 |
    | “**名称**”设置下的滑块 | 选择滑块将其关闭。 此滑块仅出现在部分 Azure 配置中。 |
    | **发布** | 选择“代码”选项****。 |
    | **运行时堆栈** | 在下拉菜单中，选择“.NET 8 (LTS)”****。 |
    | **操作系统** | 选择“Windows”。 |
    | **区域** | 保留默认选择，或选择你附近的区域。 |
    | **Windows 计划** | 保留默认选择。 |
    | **定价计划** | 选择下拉列表，然后选择“**免费 F1**”计划。 |

1. 选择或导航到“监视 + 安全”选项卡，并输入下表中的信息****：

    | 设置 | 操作 |
    |--|--|
    | **启用 Application Insights** | 选择**是**。 |
    | **Application Insights** | 选择“新建”，这将出现一个对话框****。 在对话框的“名称”字段中输入 `autoinstrument-insights`****。 然后选择“确定”以接受该名称****。 |
    | **工作区** | 如果该字段尚未填充且未处于锁定状态，请输入 `Workspace`。 |

1. 选择“查看 + 创建”以查看部署的详细信息****。 然后选择“创建”以创建资源****。

部署可能需要几分钟时间才能完成。 完成部署后，选择“转到资源”按钮****。

### 配置检测设置

要在不更改代码的情况下启用监视，需要在服务级别为应用配置检测。

1. 在左侧导航菜单中，展开“监视”，然后选择“Application Insights”********。

1. 找到“检测应用程序”部分，然后选择“.NET Core”********。

1. 在“集合级别”部分，选择“建议”********。

1. 选择“应用”，然后确认更改****。

1. 在左侧导航菜单中，选择“概述”****。

## 创建和部署 Blazor 应用

在练习的此部分，你将在 Cloud Shell 中创建 Blazor 应用，并将其部署到创建的 Web 应用。 本部分中的所有步骤都在 Cloud Shell 中执行。

1. 使用页面顶部搜索栏右侧的 **[\>_]** 按钮在 Azure 门户中创建新的 Cloud Shell，选择 ***Bash*** 环境。 Cloud Shell 在 Azure 门户底部的窗格中提供命令行接口。 如果系统提示你选择存储帐户来保存文件，请选择“不需要存储帐户”、你的订阅，然后选择“应用”********。

    > **备注**：如果以前创建了使用 *PowerShell* 环境的 Cloud Shell，请将其切换到 ***Bash***。

1. 运行以下命令，为 Blazor 应用创建目录并切换到该目录。

    ```
    mkdir blazor
    cd blazor
    ```

1. 运行以下命令，在文件夹中创建新的 Blazor 应用。

    ```
    dotnet new blazor
    ```

1. 运行以下命令以生成应用程序，确保在创建过程中没有任何问题。

    ```
    dotnet build
    ```

### 将应用部署到应用服务

要部署应用，首先需要使用 dotnet publish 命令发布应用，然后创建一个 .zip 文件进行部署******。

1. 运行以下命令，将应用发布到 publish 目录**。

    ```
    dotnet publish -c Release -o ./publish
    ```

1. 运行以下命令，为已发布的应用创建一个 .zip 文件**。 .zip 文件将位于应用程序的根目录中**。

    ```
    cd publish
    zip -r ../app.zip .
    cd ..
    ```

1. 运行以下命令，将应用部署到应用服务。 将 YOUR-WEB-APP-NAME 和 YOUR-RESOURCE-GROUP 替换为你在练习前面创建应用服务资源时使用的值********。

    ```
    az webapp deploy --name YOUR-WEB-APP-NAME \
        --resource-group YOUR-RESOURCE-GROUP \
        --src-path ./app.zip
    ```

1. 部署完成后，请在“基本信息”部分，选择“默认域”字段中的链接，在浏览器的新选项卡中打开应用********。

现在可以在 Application Insights 中查看一些基本的应用程序指标了。 请勿关闭此选项卡，在练习的后续部分你会用到它。

## 在 Application Insights 中查看指标

返回带有 Azure 门户的选项卡，然后导航到你之前创建的 Application Insights 资源。 “概述”选项卡将显示一些基本图表****：

* 失败的请求
* 服务器响应时间
* 服务器请求数
* 可用性

在本部分中，你需要在 Web 应用中执行一些操作，然后返回到此页面查看相关活动数据。 活动报告存在延迟，因此可能需要几分钟时间，这些数据才会显示在图表中。

在 Web 应用中执行以下步骤。

1. 在 Web 应用的菜单中，在 “主页”“+ 计数器”和“天气”这几个导航选项之间切换************。

1. 多次刷新网页，以生成“服务器响应时间”和“服务器请求数”数据********。

1. 要生成一些错误数据，请先选择“主页”按钮，然后在 URL 末尾追加“/failures”********。 此路由在 Web 应用中并不存在，并将生成错误。 多次刷新该页面，以生成错误数据。

1. 返回到 Application Insights 正在运行的选项卡，等待一两分钟，以便信息显示在图表中。 

1. 在左侧导航中展开“调查”部分，然后选择“失败”********。 这将显示失败的请求计数以及有关失败的响应代码的更多详细信息。

浏览其他报告选项，了解哪些其他类型的信息可用。 

## 清理资源

完成练习后，应删除已创建的云资源，以避免不必要的资源使用。

1. 在浏览器中，导航到 Azure 门户，网址为：[https://portal.azure.com](https://portal.azure.com)；如果出现提示，请使用 Azure 凭据登录。
1. 导航到创建的资源组，然后查看本练习中使用的资源内容。
1. 在工具栏中，选择“删除资源组”****。
1. 输入资源组名称，并确认要删除该资源组。

> 注意：**** 删除资源组会删除其中包含的所有资源。 如果你为本练习选择了一个现有资源组，则该资源组中超出本练习范围的任何现有资源也将被一并删除。
